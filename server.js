// ============================================================
// Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Ø§Ù„Ù…ÙƒØªØ¨Ø§Øª Ø§Ù„Ø¶Ø±ÙˆØ±ÙŠØ© (Importing Modules)
// ============================================================

// Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Ù…ÙƒØªØ¨Ø© Express Ù„Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø³ÙŠØ±ÙØ± ÙˆØ¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø±ÙˆØ§Ø¨Ø· (Routes)
const express = require('express');

// Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Ù…ÙƒØªØ¨Ø© Nodemailer Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„Ø© Ø¹Ù† Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„Ø§Øª
const nodemailer = require('nodemailer');

// Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Ù…ÙƒØªØ¨Ø© CORS Ù„Ù„Ø³Ù…Ø§Ø­ Ù„Ù„Ù…ÙˆÙ‚Ø¹ (Frontend) Ø¨Ø§Ù„ØªØ­Ø¯Ø« Ù…Ø¹ Ø§Ù„Ø³ÙŠØ±ÙØ± (Backend) Ø¨Ø¯ÙˆÙ† Ù…Ø´Ø§ÙƒÙ„ Ø£Ù…Ù†ÙŠØ©
const cors = require('cors');

// Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Ù…ÙƒØªØ¨Ø© dotenv Ù„Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø¨ÙŠØ¦ÙŠØ© (Ù…Ø«Ù„ Ø§Ù„Ø¨Ø§Ø³ÙˆØ±Ø¯) Ù…Ù† Ù…Ù„Ù .env Ù„Ø­Ù…Ø§ÙŠØªÙ‡Ø§
require('dotenv').config();

// ============================================================
// ÙØ­Øµ Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø¨ÙŠØ¦ÙŠØ© (Env Check)
// ============================================================
if (!process.env.EMAIL_USER || !process.env.EMAIL_PASS) {
    console.error("âŒ Ø®Ø·Ø£: Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ EMAIL_USER Ø£Ùˆ EMAIL_PASS ÙÙŠ Ù…Ù„Ù .env");
    console.error("âš ï¸ ØªØ£ÙƒØ¯ Ù…Ù† Ø¥Ù†Ø´Ø§Ø¡ Ù…Ù„Ù Ø¨Ø§Ø³Ù… .env Ø¨Ø¬Ø§Ù†Ø¨ server.js ÙˆÙˆØ¶Ø¹ Ø¨ÙŠØ§Ù†Ø§ØªÙƒ ÙÙŠÙ‡.");
} else {
    console.log("âœ… ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„ Ø¨Ù†Ø¬Ø§Ø­: " + process.env.EMAIL_USER);
}

// ============================================================
// Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø³ÙŠØ±ÙØ± (Server Setup)
// ============================================================

// Ø¥Ù†Ø´Ø§Ø¡ ØªØ·Ø¨ÙŠÙ‚ Express Ø¬Ø¯ÙŠØ¯
const app = express();

// ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…Ù†ÙØ° (Port) Ø§Ù„Ø°ÙŠ Ø³ÙŠØ¹Ù…Ù„ Ø¹Ù„ÙŠÙ‡ Ø§Ù„Ø³ÙŠØ±ÙØ± (Ù…Ø«Ù„Ø§Ù‹ 3000)
const PORT = process.env.PORT || 3000;

// ============================================================
// Ø§Ù„Ø¨Ø±Ù…Ø¬ÙŠØ§Øª Ø§Ù„ÙˆØ³ÙŠØ·Ø© (Middleware)
// ============================================================

// ØªÙØ¹ÙŠÙ„ CORS Ù„Ù„Ø³Ù…Ø§Ø­ Ø¨Ø·Ù„Ø¨Ø§Øª Ù…Ù† Ø£ÙŠ Ù…ØµØ¯Ø± (ÙŠÙ…ÙƒÙ† ØªØ®ØµÙŠØµÙ‡ Ù„Ø§Ø­Ù‚Ø§Ù‹)
app.use(cors());

// Ø§Ù„Ø³Ù…Ø§Ø­ Ù„Ù„Ø³ÙŠØ±ÙØ± Ø¨ÙÙ‡Ù… Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù‚Ø§Ø¯Ù…Ø© Ø¨ØµÙŠØºØ© JSON (Ù…Ù‡Ù… Ø¬Ø¯Ø§Ù‹ Ù„Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙÙˆØ±Ù…)
app.use(express.json());

// Ø§Ù„Ø³Ù…Ø§Ø­ Ù„Ù„Ø³ÙŠØ±ÙØ± Ø¨ØªÙ‚Ø¯ÙŠÙ… Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ø«Ø§Ø¨ØªØ© (HTML, CSS, JS) Ù…Ù† Ø§Ù„Ù…Ø¬Ù„Ø¯ Ø§Ù„Ø­Ø§Ù„ÙŠ
// Ù‡Ø°Ø§ ÙŠØ¬Ø¹Ù„ Ø§Ù„Ø³ÙŠØ±ÙØ± ÙŠØ¹Ø±Ø¶ Ù…ÙˆÙ‚Ø¹Ùƒ Ø¹Ù†Ø¯ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ø±Ø§Ø¨Ø· Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ
app.use(express.static(__dirname));

// ============================================================
// Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ (Email Configuration)
// ============================================================

// Ø¥Ù†Ø´Ø§Ø¡ "Ù†Ø§Ù‚Ù„" (Transporter) Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Nodemailer
// Ù‡Ø°Ø§ Ù‡Ùˆ Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„ Ø¹Ù† Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø®Ø§Ø¯Ù… Ø§Ù„Ø¨Ø±ÙŠØ¯ (Ù…Ø«Ù„ Gmail)
const transporter = nodemailer.createTransport({
    service: 'gmail', // Ù†Ø³ØªØ®Ø¯Ù… Ø®Ø¯Ù…Ø© Gmail
    auth: {
        user: process.env.EMAIL_USER, // Ø¥ÙŠÙ…ÙŠÙ„Ùƒ Ø§Ù„Ø´Ø®ØµÙŠ (Ø³ÙŠØªÙ… ÙˆØ¶Ø¹Ù‡ ÙÙŠ Ù…Ù„Ù .env)
        pass: process.env.EMAIL_PASS  // ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ (App Password) ÙˆÙ„ÙŠØ³ ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„ Ø§Ù„Ø¹Ø§Ø¯ÙŠØ©
    }
});

// ============================================================
// Ø§Ù„Ù…Ø³Ø§Ø±Ø§Øª (Routes)
// ============================================================

// 1. Ù…Ø³Ø§Ø± Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ Ù„Ø£Ù†Ù†Ø§ Ø§Ø³ØªØ®Ø¯Ù…Ù†Ø§ express.static)
app.get('/', (req, res) => {
    res.sendFile(__dirname + '/index.html');
});

// 2. Ù…Ø³Ø§Ø± Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªÙˆØ§ØµÙ„ (POST Request)
app.post('/send-email', (req, res) => {
    // Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù‚Ø§Ø¯Ù…Ø© Ù…Ù† Ø§Ù„ÙÙˆØ±Ù… (Frontend)
    const { name, email, message, _honey } = req.body;
    
    console.log(`ðŸ“© Ø§Ø³ØªÙ„Ø§Ù… Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯ Ù…Ù†: ${name} (${email})`);

    // Spam Protection (Honeypot Check)
    if (_honey) {
        return res.status(400).send('Spam detected'); // Ø±ÙØ¶ Ø§Ù„Ø·Ù„Ø¨ Ù„Ùˆ Ø§Ù„Ù…ØµÙŠØ¯Ø© Ù…Ù„ÙŠØ§Ù†Ø©
    }

    // ØªØ¬Ù‡ÙŠØ² Ø´ÙƒÙ„ Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„ Ø§Ù„Ø°ÙŠ Ø³ÙŠØµÙ„ Ø¥Ù„ÙŠÙƒ
    const mailOptions = {
        from: email, // Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„ Ø§Ù„Ù…Ø±Ø³Ù„ (Ø´ÙƒÙ„ÙŠØ§Ù‹ ÙÙ‚Ø·ØŒ Gmail ÙŠÙØ±Ø¶ Ø¥ÙŠÙ…ÙŠÙ„Ùƒ ÙƒÙ…Ø±Ø³Ù„)
        to: process.env.EMAIL_USER, // Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„ Ø§Ù„Ø°ÙŠ Ø³ÙŠØ³ØªÙ‚Ø¨Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø© (Ø¥ÙŠÙ…ÙŠÙ„Ùƒ Ø£Ù†Øª)
        subject: `New Message from Portfolio: ${name}`, // Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø±Ø³Ø§Ù„Ø©
        text: `You have received a new message from your portfolio website.
        
        Name: ${name}
        Email: ${email}
        Message: ${message}` // Ù†Øµ Ø§Ù„Ø±Ø³Ø§Ù„Ø©
    };

    // Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„ ÙØ¹Ù„ÙŠØ§Ù‹
    transporter.sendMail(mailOptions, (error, info) => {
        if (error) {
            // ÙÙŠ Ø­Ø§Ù„Ø© Ø­Ø¯ÙˆØ« Ø®Ø·Ø£ØŒ Ø§Ø·Ø¨Ø¹ Ø§Ù„Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ÙƒÙˆÙ†Ø³ÙˆÙ„ ÙˆØ£Ø±Ø³Ù„ Ø±Ø¯ Ø³Ù„Ø¨ÙŠ Ù„Ù„Ù…ÙˆÙ‚Ø¹
            console.error("âŒ ÙØ´Ù„ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„:", error);
            res.status(500).send('Error sending email');
        } else {
            // ÙÙŠ Ø­Ø§Ù„Ø© Ø§Ù„Ù†Ø¬Ø§Ø­ØŒ Ø§Ø·Ø¨Ø¹ ØªØ£ÙƒÙŠØ¯ ÙˆØ£Ø±Ø³Ù„ Ø±Ø¯ Ø¥ÙŠØ¬Ø§Ø¨ÙŠ Ù„Ù„Ù…ÙˆÙ‚Ø¹
            console.log('âœ… ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„ Ø¨Ù†Ø¬Ø§Ø­: ' + info.response);
            res.status(200).send('Email sent successfully');
        }
    });
});

// ============================================================
// ØªØ´ØºÙŠÙ„ Ø§Ù„Ø³ÙŠØ±ÙØ± (Start Server)
// ============================================================

// Ø¬Ø¹Ù„ Ø§Ù„Ø³ÙŠØ±ÙØ± ÙŠØ³ØªÙ…Ø¹ Ù„Ù„Ø·Ù„Ø¨Ø§Øª Ø¹Ù„Ù‰ Ø§Ù„Ø¨ÙˆØ±Øª Ø§Ù„Ù…Ø­Ø¯Ø¯
if (require.main === module) {
    app.listen(PORT, () => {
        console.log(`Server is running on http://localhost:${PORT}`);
    });
}

module.exports = app;
